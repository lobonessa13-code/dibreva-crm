<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DIBREVA - Financeiro</title>
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>

  <button class="mobile-toggle" aria-label="Menu">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div class="mobile-overlay"></div>

  <aside class="sidebar" id="sidebar"></aside>

  <main class="main-content">

    <div class="page-header">
      <h1>Financeiro</h1>
      <div class="page-header-actions">
        <div class="month-selector">
          <button onclick="FIN.prevMonth()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <span id="month-label">—</span>
          <button onclick="FIN.nextMonth()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>
        <button class="btn btn-secondary" onclick="FIN.exportCSV()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Exportar CSV
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card"><div class="kpi-label">Faturamento do Mês</div><div class="kpi-value success" id="kpi-faturamento">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Despesas do Mês</div><div class="kpi-value danger" id="kpi-despesas">—</div></div>
      <div class="kpi-card"><div class="kpi-label">Lucro Bruto</div><div class="kpi-value" id="kpi-lucro">—</div></div>
    </div>

    <!-- Painéis: Receitas e Despesas -->
    <div class="two-panels">

      <!-- Receitas -->
      <div class="panel">
        <div class="panel-header">
          <h3 style="color: var(--success);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -3px;"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
            Receitas
          </h3>
          <button class="btn btn-sm btn-success" onclick="FIN.openNovaReceita()">+ Receita</button>
        </div>
        <div class="panel-body" id="receitas-list">
          <div class="spinner"></div>
        </div>
      </div>

      <!-- Despesas -->
      <div class="panel">
        <div class="panel-header">
          <h3 style="color: var(--danger);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -3px;"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg>
            Despesas
          </h3>
          <button class="btn btn-sm btn-danger" onclick="FIN.openNovaDespesa()">+ Despesa</button>
        </div>
        <div class="panel-body" id="despesas-list">
          <div class="spinner"></div>
        </div>
      </div>

    </div>

    <!-- Gráfico Fluxo de Caixa -->
    <div class="chart-card">
      <h3>Fluxo de Caixa — Últimos 6 Meses</h3>
      <canvas id="chart-fluxo"></canvas>
    </div>

  </main>

  <!-- Modal: Receita -->
  <div class="modal-overlay" id="modal-receita">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-receita-title">Nova Receita</h2>
        <button class="modal-close" onclick="UI.closeModal('modal-receita')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="receita-id">
        <div class="form-group">
          <label>Obra vinculada</label>
          <select class="form-control" id="receita-obra-id">
            <option value="">— Sem vínculo —</option>
          </select>
        </div>
        <div class="form-group">
          <label>Descrição <span class="required">*</span></label>
          <input type="text" class="form-control" id="receita-descricao" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Valor (R$) <span class="required">*</span></label>
            <input type="number" class="form-control" id="receita-valor" step="0.01" min="0">
          </div>
          <div class="form-group">
            <label>Data Prevista <span class="required">*</span></label>
            <input type="date" class="form-control" id="receita-data">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Parcelas</label>
            <input type="number" class="form-control" id="receita-parcelas" value="1" min="1" max="48">
            <small style="color: var(--cinza); font-size: 11px;">Divide o valor em parcelas mensais</small>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select class="form-control" id="receita-status">
              <option value="previsto">Previsto</option>
              <option value="recebido">Recebido</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="UI.closeModal('modal-receita')">Cancelar</button>
        <button class="btn btn-success" onclick="FIN.saveReceita()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Despesa -->
  <div class="modal-overlay" id="modal-despesa">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-despesa-title">Nova Despesa</h2>
        <button class="modal-close" onclick="UI.closeModal('modal-despesa')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="despesa-id">
        <div class="form-group">
          <label>Obra vinculada</label>
          <select class="form-control" id="despesa-obra-id">
            <option value="">— Sem vínculo —</option>
          </select>
        </div>
        <div class="form-group">
          <label>Descrição <span class="required">*</span></label>
          <input type="text" class="form-control" id="despesa-descricao" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Categoria <span class="required">*</span></label>
            <select class="form-control" id="despesa-categoria">
              <option value="Material">Material</option>
              <option value="Mao de obra">Mão de obra</option>
              <option value="Equipamento">Equipamento</option>
              <option value="Transporte">Transporte</option>
              <option value="Administrativo">Administrativo</option>
              <option value="Imposto">Imposto</option>
              <option value="Geral">Geral</option>
            </select>
          </div>
          <div class="form-group">
            <label>Valor (R$) <span class="required">*</span></label>
            <input type="number" class="form-control" id="despesa-valor" step="0.01" min="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Data Vencimento <span class="required">*</span></label>
            <input type="date" class="form-control" id="despesa-data">
          </div>
          <div class="form-group">
            <label>Status</label>
            <select class="form-control" id="despesa-status">
              <option value="pendente">Pendente</option>
              <option value="pago">Pago</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="UI.closeModal('modal-despesa')">Cancelar</button>
        <button class="btn btn-danger" onclick="FIN.saveDespesa()">Salvar</button>
      </div>
    </div>
  </div>

  <script src="js/supabase-config.js?v=5"></script>
  <script src="js/db.js?v=5"></script>
  <script src="js/ui.js?v=5"></script>
  <script src="js/nav.js?v=5"></script>
  <script src="js/financeiro.js?v=5"></script>
  <script>
    document.getElementById('sidebar').innerHTML = renderSidebar('financeiro');
    FIN.init();
  </script>
</body>
</html>
